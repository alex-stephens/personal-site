{"version":3,"file":"rehype-citation.es.js","sources":["../regex.js","../parse-citation.js","../csl/mla.js","../csl/chicago.js","../index.js"],"sourcesContent":["/**\n * Captures normal citation in square bracket and in-text citation\n * Citation key start should start with a letter, digit, or _,\n * and contains only alphanumerics and single internal punctuation characters (:.#$%&-+?<>~/),\n *\n * e.g. [-@wadler1990], [@hughes1989, sec 3.4], [see @wadler1990; and @hughes1989, pp. 4]\n * and @wadler1990\n *\n * Group #1 - citation term without [] bracket e.g. -@wadler1990\n * Group #2 - in-text citation term e.g. @wadler1990\n *\n * \\[([^[\\]]*@[^[\\]]+)\\] for group #1\n * (?!\\b)@([a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\\-+?<>~]*) for group #2\n * Use (?!\\b) to avoid email like address e.g. xyx@google.com\n * */\nexport const citeExtractorRe =\n  /\\[([^[\\]]*@[^[\\]]+)\\]|(?!\\b)(@[a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\\-+?<>~]*)/\nexport const citeKeyRe = /@([a-zA-Z0-9_][a-zA-Z0-9_:.#$%&\\-+?<>~]*)/g\nexport const citeBracketRe = /\\[.*\\]/\n","/**\n * @typedef CiteItem\n *   Cite item to be passed into citeproc-js\n * @property {string} [id]\n *   The id field is required\n * @property {string} [locator]\n *   A string identifying a page number or other pinpoint location or range within the resource;\n * @property {string} [label]\n *   Path to file\n * @property {string} [prefix]\n *   A string to print before this cite item\n * @property {string} [suffix]\n *   A string to print after this cite item\n * @property {boolean} [suppress-author]\n *   If true, author names will not be included in the citation output for this cite\n * @property {boolean} [author-only]\n *   If true, only the author name will be included in the citation output for this cite\n */\n\nimport { citeBracketRe, citeKeyRe } from './regex.js'\n\nconst locatorMapping = {\n  book: 'book',\n  'bk.': 'book',\n  'bks.': 'book',\n  chapter: 'chapter',\n  'chap.': 'chapter',\n  'chaps.': 'chapter',\n  column: 'column',\n  'col.': 'column',\n  'cols.': 'column',\n  figure: 'figure',\n  'fig.': 'figure',\n  'figs.': 'figure',\n  folio: 'folio',\n  'fol.': 'folio',\n  'fols.': 'folio',\n  number: 'number',\n  'no.': 'number',\n  'nos.': 'number',\n  line: 'line',\n  'l.': 'line',\n  'll.': 'line',\n  note: 'note',\n  'n.': 'note',\n  'nn.': 'note',\n  opus: 'opus',\n  'op.': 'opus',\n  'opp.': 'opus',\n  page: 'page',\n  'p.': 'page',\n  'pp.': 'page',\n  paragraph: 'paragraph',\n  'para.': 'paragraph',\n  'paras.': 'paragraph',\n  part: 'part',\n  'pt.': 'part',\n  'pts.': 'part',\n  section: 'section',\n  'sec.': 'section',\n  'secs.': 'section',\n  'sub verbo': 'sub verbo',\n  's.v.': 'sub verbo',\n  's.vv.': 'sub verbo',\n  verse: 'verse',\n  'v.': 'verse',\n  'vv.': 'verse',\n  volume: 'volume',\n  'vol.': 'volume',\n  'vols.': 'volume',\n  '¶': 'paragraph',\n  '¶¶': 'paragraph',\n  '§': 'section',\n  '§§': 'section',\n}\n\n/**\n * Parses a given citation string and return properties and entries required for cite-proc.\n * Adapted from https://github.com/Zettlr/Citr/blob/master/lib/citr.ts\n *\n * @param {string} citeString Cite string in the form of '[@item]' or '@item'\n * @return {[Object, CiteItem[]]} [properties, entries]\n */\nexport const parseCitation = (citeString) => {\n  /** @type {CiteItem[]} */\n  let entries = []\n  let properties\n  if (citeBracketRe.test(citeString)) {\n    properties = { noteIndex: 0 }\n    // Handle citations in the form of [@item1; @item2]\n    const citeItems = citeString.substr(1, citeString.length - 2).split(';')\n    for (const citeItem of citeItems) {\n      // Prefix is the portion before @ e.g. [see @item1] or an empty string\n      let prefix = ''\n      let locator = ''\n      let label = 'page'\n      let suffix = ''\n      const citeChunk = citeItem.split('@')\n      if (citeChunk.length === 1) {\n        throw new Error('Cite key should be in the form of @key')\n      } else if (citeChunk.length > 2) {\n        throw new Error('More than one cite key @ detected, please separate keys with ;')\n      }\n      prefix += citeChunk[0]\n      prefix = prefix.trim()\n\n      // If [-@item1], suppress author\n      let suppressAuthor = citeItem.indexOf('@') > 0 && citeItem[citeItem.indexOf('@') - 1] === '-'\n      if (suppressAuthor) prefix = prefix.substr(0, prefix.length - 1).trim()\n\n      // The citation key can be terminated with a comma or space\n      let commaIndex = citeChunk[1].indexOf(',') + 1\n      // If the commaIndex is 0, this means there was no comma - check for space\n      if (commaIndex === 0) commaIndex = citeChunk[1].indexOf(' ') + 1\n      // Pass undefined to extract everything\n      if (commaIndex <= 0) commaIndex = undefined\n      const citeKey = citeItem.substr(citeItem.indexOf('@'), commaIndex).match(citeKeyRe)[0]\n\n      // We are left with the locator, suffix and label\n      let afterKey = citeItem.split('@')[1].substr(citeKey.length).trim()\n      if (afterKey[0] === ',') afterKey = afterKey.substr(1).trim()\n      // Locator should be in the form of 11-22, 33\n      // Would not work form roman numerals or alphabetical sections\n      const locatorMatch = afterKey.match(/(\\d|-| |,)+/g)\n      if (locatorMatch !== null) {\n        locator = locatorMatch[0].trim()\n        // String before the locator is taken to be the label\n        // Use heuristic from https://pandoc.org/MANUAL.html#citation-syntax to convert locator label to valid\n        // Label has to be one of the following: https://docs.citationstyles.org/en/stable/specification.html#locators\n        label = afterKey.split(locator)[0].trim()\n        label = locatorMapping[label] || 'page'\n        // String after the locator is taken to be the suffix\n        suffix = afterKey.split(locator)[1].trim()\n      } else {\n        // If no locator is found, entire string is assumed to be the suffix\n        suffix = afterKey.trim()\n      }\n\n      entries.push({\n        // Get the first capture group which returns the citekey without @\n        id: [...citeItem.matchAll(citeKeyRe)][0][1],\n        locator,\n        label,\n        prefix,\n        suffix,\n        'suppress-author': suppressAuthor,\n      })\n    }\n  } else {\n    // Single item in the form of @item1\n    // See https://citeproc-js.readthedocs.io/en/latest/running.html#special-citation-forms\n    properties = { noteIndex: 0, mode: 'composite' }\n    entries = [citeString].map((str) => ({\n      id: [...str.matchAll(citeKeyRe)][0][1],\n    }))\n  }\n  return [properties, entries]\n}\n","export default `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<style xmlns=\"http://purl.org/net/xbiblio/csl\" class=\"in-text\" version=\"1.0\" demote-non-dropping-particle=\"never\" page-range-format=\"minimal-two\">\n  <info>\n    <title>Modern Language Association 9th edition</title>\n    <title-short>MLA</title-short>\n    <id>http://www.zotero.org/styles/modern-language-association</id>\n    <link href=\"http://www.zotero.org/styles/modern-language-association\" rel=\"self\"/>\n    <link href=\"http://style.mla.org\" rel=\"documentation\"/>\n    <author>\n      <name>Sebastian Karcher</name>\n    </author>\n    <category citation-format=\"author\"/>\n    <category field=\"generic-base\"/>\n    <summary>This style adheres to the MLA 9th edition handbook. Follows the structure of references as outlined in the MLA Manual closely</summary>\n    <updated>2021-07-13T20:05:10+00:00</updated>\n    <rights license=\"http://creativecommons.org/licenses/by-sa/3.0/\">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>\n  </info>\n  <locale xml:lang=\"en\">\n    <date form=\"text\">\n      <date-part name=\"day\" suffix=\" \"/>\n      <date-part name=\"month\" suffix=\" \" form=\"short\"/>\n      <date-part name=\"year\"/>\n    </date>\n    <terms>\n      <term name=\"month-01\" form=\"short\">Jan.</term>\n      <term name=\"month-02\" form=\"short\">Feb.</term>\n      <term name=\"month-03\" form=\"short\">Mar.</term>\n      <term name=\"month-04\" form=\"short\">Apr.</term>\n      <term name=\"month-05\" form=\"short\">May</term>\n      <term name=\"month-06\" form=\"short\">June</term>\n      <term name=\"month-07\" form=\"short\">July</term>\n      <term name=\"month-08\" form=\"short\">Aug.</term>\n      <term name=\"month-09\" form=\"short\">Sept.</term>\n      <term name=\"month-10\" form=\"short\">Oct.</term>\n      <term name=\"month-11\" form=\"short\">Nov.</term>\n      <term name=\"month-12\" form=\"short\">Dec.</term>\n      <term name=\"translator\" form=\"short\">trans.</term>\n    </terms>\n  </locale>\n  <macro name=\"author\">\n    <names variable=\"author\">\n      <name name-as-sort-order=\"first\" and=\"text\" delimiter-precedes-last=\"always\" delimiter-precedes-et-al=\"always\" initialize=\"false\" initialize-with=\". \"/>\n      <label form=\"long\" prefix=\", \"/>\n      <substitute>\n        <names variable=\"editor\"/>\n        <names variable=\"translator\"/>\n        <text macro=\"title\"/>\n      </substitute>\n    </names>\n  </macro>\n  <macro name=\"author-short\">\n    <group delimiter=\", \">\n      <names variable=\"author\">\n        <name form=\"short\" initialize-with=\". \" and=\"text\"/>\n        <substitute>\n          <names variable=\"editor\"/>\n          <names variable=\"translator\"/>\n          <text macro=\"title-short\"/>\n        </substitute>\n      </names>\n      <choose>\n        <if disambiguate=\"true\">\n          <text macro=\"title-short\"/>\n        </if>\n      </choose>\n    </group>\n  </macro>\n  <macro name=\"title\">\n    <choose>\n      <if variable=\"container-title\" match=\"any\">\n        <text variable=\"title\" quotes=\"true\" text-case=\"title\"/>\n      </if>\n      <else>\n        <text variable=\"title\" font-style=\"italic\" text-case=\"title\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"title-short\">\n    <choose>\n      <if variable=\"container-title\" match=\"any\">\n        <text variable=\"title\" form=\"short\" quotes=\"true\" text-case=\"title\"/>\n      </if>\n      <else>\n        <text variable=\"title\" form=\"short\" font-style=\"italic\" text-case=\"title\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"container-title\">\n    <text variable=\"container-title\" font-style=\"italic\" text-case=\"title\"/>\n  </macro>\n  <macro name=\"other-contributors\">\n    <choose>\n      <if variable=\"container-title\" match=\"any\">\n        <group delimiter=\", \">\n          <names variable=\"container-author\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \"/>\n            <name and=\"text\"/>\n          </names>\n          <names variable=\"editor translator\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \"/>\n            <name and=\"text\"/>\n          </names>\n          <names variable=\"director illustrator interviewer\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \"/>\n            <name and=\"text\"/>\n          </names>\n        </group>\n      </if>\n      <else>\n        <group delimiter=\", \">\n          <names variable=\"container-author\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \" text-case=\"capitalize-first\"/>\n            <name and=\"text\"/>\n          </names>\n          <names variable=\"editor translator\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \" text-case=\"capitalize-first\"/>\n            <name and=\"text\"/>\n          </names>\n          <names variable=\"director illustrator interviewer\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \" text-case=\"capitalize-first\"/>\n            <name and=\"text\"/>\n          </names>\n        </group>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"version\">\n    <group delimiter=\", \">\n      <choose>\n        <if is-numeric=\"edition\">\n          <group delimiter=\" \">\n            <number variable=\"edition\" form=\"ordinal\"/>\n            <text term=\"edition\" form=\"short\"/>\n          </group>\n        </if>\n        <else>\n          <text variable=\"edition\" text-case=\"capitalize-first\"/>\n        </else>\n      </choose>\n      <text variable=\"version\"/>\n    </group>\n  </macro>\n  <macro name=\"volume-lowercase\">\n    <group delimiter=\" \">\n      <text term=\"volume\" form=\"short\"/>\n      <text variable=\"volume\"/>\n    </group>\n  </macro>\n  <macro name=\"number\">\n    <group delimiter=\", \">\n      <group>\n        <choose>\n          <!--lowercase if we have a preceding element-->\n          <if variable=\"edition container-title\" match=\"any\">\n            <text macro=\"volume-lowercase\"/>\n          </if>\n          <!--other contributors preceding the volume-->\n          <else-if variable=\"author\" match=\"all\">\n            <choose>\n              <if variable=\"editor translator container-author illustrator interviewer director\" match=\"any\">\n                <text macro=\"volume-lowercase\"/>\n              </if>\n            </choose>\n          </else-if>\n          <else-if variable=\"editor\" match=\"all\">\n            <choose>\n              <if variable=\"translator container-author illustrator interviewer director\" match=\"any\">\n                <text macro=\"volume-lowercase\"/>\n              </if>\n            </choose>\n          </else-if>\n          <else-if variable=\"container-author illustrator interviewer director\" match=\"any\">\n            <text macro=\"volume-lowercase\"/>\n          </else-if>\n          <else>\n            <group delimiter=\" \">\n              <text term=\"volume\" form=\"short\" text-case=\"capitalize-first\"/>\n              <text variable=\"volume\"/>\n            </group>\n          </else>\n        </choose>\n      </group>\n      <group delimiter=\" \">\n        <text term=\"issue\" form=\"short\"/>\n        <text variable=\"issue\"/>\n      </group>\n      <choose>\n        <if type=\"report\">\n          <text variable=\"genre\"/>\n        </if>\n      </choose>\n      <text variable=\"number\"/>\n    </group>\n  </macro>\n  <macro name=\"publisher\">\n    <text variable=\"publisher\"/>\n  </macro>\n  <macro name=\"publication-date\">\n    <choose>\n      <if type=\"book chapter paper-conference motion_picture\" match=\"any\">\n        <date variable=\"issued\" form=\"numeric\" date-parts=\"year\"/>\n      </if>\n      <else-if type=\"article-journal article-magazine\" match=\"any\">\n        <date variable=\"issued\" form=\"text\" date-parts=\"year-month\"/>\n      </else-if>\n      <else-if type=\"speech\" match=\"none\">\n        <date variable=\"issued\" form=\"text\"/>\n      </else-if>\n    </choose>\n  </macro>\n  <macro name=\"location\">\n    <group delimiter=\", \">\n      <group delimiter=\" \">\n        <label variable=\"page\" form=\"short\"/>\n        <text variable=\"page\"/>\n      </group>\n      <choose>\n        <if variable=\"source\" match=\"none\">\n          <text macro=\"URI\"/>\n        </if>\n      </choose>\n    </group>\n  </macro>\n  <macro name=\"container2-title\">\n    <group delimiter=\", \">\n      <choose>\n        <if type=\"speech\">\n          <text variable=\"event\"/>\n          <date variable=\"event-date\" form=\"text\"/>\n          <text variable=\"event-place\"/>\n        </if>\n      </choose>\n      <text variable=\"archive\"/>\n      <text variable=\"archive-place\"/>\n      <text variable=\"archive_location\"/>\n    </group>\n  </macro>\n  <macro name=\"container2-location\">\n    <choose>\n      <if variable=\"source\">\n        <choose>\n          <if variable=\"DOI URL\" match=\"any\">\n            <group delimiter=\", \">\n              <text variable=\"source\" font-style=\"italic\"/>\n              <text macro=\"URI\"/>\n            </group>\n          </if>\n        </choose>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"URI\">\n    <choose>\n      <if variable=\"DOI\">\n        <text variable=\"DOI\" prefix=\"https://doi.org/\"/>\n      </if>\n      <else>\n        <text variable=\"URL\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"accessed\">\n    <!--using accessed where we don't have an issued date; follows recommendation on p. 53 -->\n    <choose>\n      <if variable=\"issued\" match=\"none\">\n        <group delimiter=\" \">\n          <text term=\"accessed\" text-case=\"capitalize-first\"/>\n          <date variable=\"accessed\" form=\"text\"/>\n        </group>\n      </if>\n    </choose>\n  </macro>\n  <citation et-al-min=\"3\" et-al-use-first=\"1\" disambiguate-add-names=\"true\" disambiguate-add-givenname=\"true\">\n    <layout prefix=\"(\" suffix=\")\" delimiter=\"; \">\n      <choose>\n        <if locator=\"page line\" match=\"any\">\n          <group delimiter=\" \">\n            <text macro=\"author-short\"/>\n            <text variable=\"locator\"/>\n          </group>\n        </if>\n        <else>\n          <group delimiter=\", \">\n            <text macro=\"author-short\"/>\n            <group>\n              <label variable=\"locator\" form=\"short\"/>\n              <text variable=\"locator\"/>\n            </group>\n          </group>\n        </else>\n      </choose>\n    </layout>\n  </citation>\n  <bibliography hanging-indent=\"true\" et-al-min=\"3\" et-al-use-first=\"1\" line-spacing=\"2\" entry-spacing=\"0\" subsequent-author-substitute=\"---\">\n    <sort>\n      <key macro=\"author\"/>\n      <key variable=\"title\"/>\n    </sort>\n    <layout suffix=\".\">\n      <group delimiter=\". \">\n        <text macro=\"author\"/>\n        <text macro=\"title\"/>\n        <date variable=\"original-date\" form=\"numeric\" date-parts=\"year\"/>\n        <group delimiter=\", \">\n          <!---This group corresponds to MLA's \"Container 1\"-->\n          <text macro=\"container-title\"/>\n          <text macro=\"other-contributors\"/>\n          <text macro=\"version\"/>\n          <text macro=\"number\"/>\n          <text macro=\"publisher\"/>\n          <text macro=\"publication-date\"/>\n          <text macro=\"location\"/>\n        </group>\n        <group delimiter=\", \">\n          <!---This group corresponds to MLA's \"Container 2\"-->\n          <!--currently just using this one for archival info-->\n          <text macro=\"container2-title\"/>\n          <text macro=\"container2-location\"/>\n        </group>\n        <text macro=\"accessed\"/>\n      </group>\n    </layout>\n  </bibliography>\n</style>`\n","export default `<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<style xmlns=\"http://purl.org/net/xbiblio/csl\" class=\"in-text\" version=\"1.0\" demote-non-dropping-particle=\"display-and-sort\" page-range-format=\"chicago\">\n  <info>\n    <title>Chicago Manual of Style 17th edition (author-date)</title>\n    <id>http://www.zotero.org/styles/chicago-author-date</id>\n    <link href=\"http://www.zotero.org/styles/chicago-author-date\" rel=\"self\"/>\n    <link href=\"http://www.chicagomanualofstyle.org/tools_citationguide.html\" rel=\"documentation\"/>\n    <author>\n      <name>Julian Onions</name>\n      <email>julian.onions@gmail.com</email>\n    </author>\n    <contributor>\n      <name>Sebastian Karcher</name>\n    </contributor>\n    <contributor>\n      <name>Richard Karnesky</name>\n      <email>karnesky+zotero@gmail.com</email>\n      <uri>http://arc.nucapt.northwestern.edu/Richard_Karnesky</uri>\n    </contributor>\n    <contributor>\n      <name>Andrew Dunning</name>\n      <email>andrew.dunning@utoronto.ca</email>\n      <uri>https://orcid.org/0000-0003-0464-5036</uri>\n    </contributor>\n    <contributor>\n      <name>Matthew Roth</name>\n      <email>matthew.g.roth@yale.edu</email>\n      <uri> https://orcid.org/0000-0001-7902-6331</uri>\n    </contributor>\n    <contributor>\n      <name>Brenton M. Wiernik</name>\n    </contributor>\n    <category citation-format=\"author-date\"/>\n    <category field=\"generic-base\"/>\n    <summary>The author-date variant of the Chicago style</summary>\n    <updated>2018-01-24T12:00:00+00:00</updated>\n    <rights license=\"http://creativecommons.org/licenses/by-sa/3.0/\">This work is licensed under a Creative Commons Attribution-ShareAlike 3.0 License</rights>\n  </info>\n  <locale xml:lang=\"en\">\n    <terms>\n      <term name=\"editor\" form=\"verb-short\">ed.</term>\n      <term name=\"container-author\" form=\"verb\">by</term>\n      <term name=\"translator\" form=\"verb-short\">trans.</term>\n      <term name=\"editortranslator\" form=\"verb\">edited and translated by</term>\n      <term name=\"translator\" form=\"short\">trans.</term>\n    </terms>\n  </locale>\n  <macro name=\"secondary-contributors\">\n    <choose>\n      <if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"none\">\n        <group delimiter=\". \">\n          <names variable=\"editor translator\" delimiter=\". \">\n            <label form=\"verb\" text-case=\"capitalize-first\" suffix=\" \"/>\n            <name and=\"text\" delimiter=\", \"/>\n          </names>\n          <names variable=\"director\" delimiter=\". \">\n            <label form=\"verb\" text-case=\"capitalize-first\" suffix=\" \"/>\n            <name and=\"text\" delimiter=\", \"/>\n          </names>\n        </group>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"container-contributors\">\n    <choose>\n      <if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"any\">\n        <group prefix=\", \" delimiter=\", \">\n          <names variable=\"container-author\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \"/>\n            <name and=\"text\" delimiter=\", \"/>\n          </names>\n          <names variable=\"editor translator\" delimiter=\", \">\n            <label form=\"verb\" suffix=\" \"/>\n            <name and=\"text\" delimiter=\", \"/>\n          </names>\n        </group>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"editor\">\n    <names variable=\"editor\">\n      <name name-as-sort-order=\"first\" and=\"text\" sort-separator=\", \" delimiter=\", \" delimiter-precedes-last=\"always\"/>\n      <label form=\"short\" prefix=\", \"/>\n    </names>\n  </macro>\n  <macro name=\"translator\">\n    <names variable=\"translator\">\n      <name name-as-sort-order=\"first\" and=\"text\" sort-separator=\", \" delimiter=\", \" delimiter-precedes-last=\"always\"/>\n      <label form=\"short\" prefix=\", \"/>\n    </names>\n  </macro>\n  <macro name=\"recipient\">\n    <choose>\n      <if type=\"personal_communication\">\n        <choose>\n          <if variable=\"genre\">\n            <text variable=\"genre\" text-case=\"capitalize-first\"/>\n          </if>\n          <else>\n            <text term=\"letter\" text-case=\"capitalize-first\"/>\n          </else>\n        </choose>\n      </if>\n    </choose>\n    <names variable=\"recipient\" delimiter=\", \">\n      <label form=\"verb\" prefix=\" \" text-case=\"lowercase\" suffix=\" \"/>\n      <name and=\"text\" delimiter=\", \"/>\n    </names>\n  </macro>\n  <macro name=\"substitute-title\">\n    <choose>\n      <if type=\"article-magazine article-newspaper review review-book\" match=\"any\">\n        <text macro=\"container-title\"/>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"contributors\">\n    <group delimiter=\". \">\n      <names variable=\"author\">\n        <name and=\"text\" name-as-sort-order=\"first\" sort-separator=\", \" delimiter=\", \" delimiter-precedes-last=\"always\"/>\n        <label form=\"short\" prefix=\", \"/>\n        <substitute>\n          <names variable=\"editor\"/>\n          <names variable=\"translator\"/>\n          <names variable=\"director\"/>\n          <text macro=\"substitute-title\"/>\n          <text macro=\"title\"/>\n        </substitute>\n      </names>\n      <text macro=\"recipient\"/>\n    </group>\n  </macro>\n  <macro name=\"contributors-short\">\n    <names variable=\"author\">\n      <name form=\"short\" and=\"text\" delimiter=\", \" initialize-with=\". \"/>\n      <substitute>\n        <names variable=\"editor\"/>\n        <names variable=\"translator\"/>\n        <names variable=\"director\"/>\n        <text macro=\"substitute-title\"/>\n        <text macro=\"title\"/>\n      </substitute>\n    </names>\n  </macro>\n  <macro name=\"interviewer\">\n    <names variable=\"interviewer\" delimiter=\", \">\n      <label form=\"verb\" prefix=\" \" text-case=\"capitalize-first\" suffix=\" \"/>\n      <name and=\"text\" delimiter=\", \"/>\n    </names>\n  </macro>\n  <macro name=\"archive\">\n    <group delimiter=\". \">\n      <text variable=\"archive_location\" text-case=\"capitalize-first\"/>\n      <text variable=\"archive\"/>\n      <text variable=\"archive-place\"/>\n    </group>\n  </macro>\n  <macro name=\"access\">\n    <group delimiter=\". \">\n      <choose>\n        <if type=\"graphic report\" match=\"any\">\n          <text macro=\"archive\"/>\n        </if>\n        <else-if type=\"article-journal bill book chapter legal_case legislation motion_picture paper-conference\" match=\"none\">\n          <text macro=\"archive\"/>\n        </else-if>\n      </choose>\n      <choose>\n        <if type=\"webpage post-weblog\" match=\"any\">\n          <date variable=\"issued\" form=\"text\"/>\n        </if>\n      </choose>\n      <choose>\n        <if variable=\"issued\" match=\"none\">\n          <group delimiter=\" \">\n            <text term=\"accessed\" text-case=\"capitalize-first\"/>\n            <date variable=\"accessed\" form=\"text\"/>\n          </group>\n        </if>\n      </choose>\n      <choose>\n        <if type=\"legal_case\" match=\"none\">\n          <choose>\n            <if variable=\"DOI\">\n              <text variable=\"DOI\" prefix=\"https://doi.org/\"/>\n            </if>\n            <else>\n              <text variable=\"URL\"/>\n            </else>\n          </choose>\n        </if>\n      </choose>\n    </group>\n  </macro>\n  <macro name=\"title\">\n    <choose>\n      <if variable=\"title\" match=\"none\">\n        <choose>\n          <if type=\"personal_communication\" match=\"none\">\n            <text variable=\"genre\" text-case=\"capitalize-first\"/>\n          </if>\n        </choose>\n      </if>\n      <else-if type=\"bill book graphic legislation motion_picture song\" match=\"any\">\n        <text variable=\"title\" text-case=\"title\" font-style=\"italic\"/>\n        <group prefix=\" (\" suffix=\")\" delimiter=\" \">\n          <text term=\"version\"/>\n          <text variable=\"version\"/>\n        </group>\n      </else-if>\n      <else-if variable=\"reviewed-author\">\n        <choose>\n          <if variable=\"reviewed-title\">\n            <group delimiter=\". \">\n              <text variable=\"title\" text-case=\"title\" quotes=\"true\"/>\n              <group delimiter=\", \">\n                <text variable=\"reviewed-title\" text-case=\"title\" font-style=\"italic\" prefix=\"Review of \"/>\n                <names variable=\"reviewed-author\">\n                  <label form=\"verb-short\" text-case=\"lowercase\" suffix=\" \"/>\n                  <name and=\"text\" delimiter=\", \"/>\n                </names>\n              </group>\n            </group>\n          </if>\n          <else>\n            <group delimiter=\", \">\n              <text variable=\"title\" text-case=\"title\" font-style=\"italic\" prefix=\"Review of \"/>\n              <names variable=\"reviewed-author\">\n                <label form=\"verb-short\" text-case=\"lowercase\" suffix=\" \"/>\n                <name and=\"text\" delimiter=\", \"/>\n              </names>\n            </group>\n          </else>\n        </choose>\n      </else-if>\n      <else-if type=\"legal_case interview patent\" match=\"any\">\n        <text variable=\"title\"/>\n      </else-if>\n      <else>\n        <text variable=\"title\" text-case=\"title\" quotes=\"true\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"edition\">\n    <choose>\n      <if type=\"bill book graphic legal_case legislation motion_picture report song\" match=\"any\">\n        <choose>\n          <if is-numeric=\"edition\">\n            <group delimiter=\" \" prefix=\". \">\n              <number variable=\"edition\" form=\"ordinal\"/>\n              <text term=\"edition\" form=\"short\" strip-periods=\"true\"/>\n            </group>\n          </if>\n          <else>\n            <text variable=\"edition\" text-case=\"capitalize-first\" prefix=\". \"/>\n          </else>\n        </choose>\n      </if>\n      <else-if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"any\">\n        <choose>\n          <if is-numeric=\"edition\">\n            <group delimiter=\" \" prefix=\", \">\n              <number variable=\"edition\" form=\"ordinal\"/>\n              <text term=\"edition\" form=\"short\"/>\n            </group>\n          </if>\n          <else>\n            <text variable=\"edition\" prefix=\", \"/>\n          </else>\n        </choose>\n      </else-if>\n    </choose>\n  </macro>\n  <macro name=\"locators\">\n    <choose>\n      <if type=\"article-journal\">\n        <choose>\n          <if variable=\"volume\">\n            <text variable=\"volume\" prefix=\" \"/>\n            <group prefix=\" (\" suffix=\")\">\n              <choose>\n                <if variable=\"issue\">\n                  <text variable=\"issue\"/>\n                </if>\n                <else>\n                  <date variable=\"issued\">\n                    <date-part name=\"month\"/>\n                  </date>\n                </else>\n              </choose>\n            </group>\n          </if>\n          <else-if variable=\"issue\">\n            <group delimiter=\" \" prefix=\", \">\n              <text term=\"issue\" form=\"short\"/>\n              <text variable=\"issue\"/>\n              <date variable=\"issued\" prefix=\"(\" suffix=\")\">\n                <date-part name=\"month\"/>\n              </date>\n            </group>\n          </else-if>\n          <else>\n            <date variable=\"issued\" prefix=\", \">\n              <date-part name=\"month\"/>\n            </date>\n          </else>\n        </choose>\n      </if>\n      <else-if type=\"legal_case\">\n        <text variable=\"volume\" prefix=\", \"/>\n        <text variable=\"container-title\" prefix=\" \"/>\n        <text variable=\"page\" prefix=\" \"/>\n      </else-if>\n      <else-if type=\"bill book graphic legal_case legislation motion_picture report song\" match=\"any\">\n        <group prefix=\". \" delimiter=\". \">\n          <group>\n            <text term=\"volume\" form=\"short\" text-case=\"capitalize-first\" suffix=\" \"/>\n            <number variable=\"volume\" form=\"numeric\"/>\n          </group>\n          <group>\n            <number variable=\"number-of-volumes\" form=\"numeric\"/>\n            <text term=\"volume\" form=\"short\" prefix=\" \" plural=\"true\"/>\n          </group>\n        </group>\n      </else-if>\n      <else-if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"any\">\n        <choose>\n          <if variable=\"page\" match=\"none\">\n            <group prefix=\". \">\n              <text term=\"volume\" form=\"short\" text-case=\"capitalize-first\" suffix=\" \"/>\n              <number variable=\"volume\" form=\"numeric\"/>\n            </group>\n          </if>\n        </choose>\n      </else-if>\n    </choose>\n  </macro>\n  <macro name=\"locators-chapter\">\n    <choose>\n      <if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"any\">\n        <choose>\n          <if variable=\"page\">\n            <group prefix=\", \">\n              <text variable=\"volume\" suffix=\":\"/>\n              <text variable=\"page\"/>\n            </group>\n          </if>\n        </choose>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"locators-article\">\n    <choose>\n      <if type=\"article-newspaper\">\n        <group prefix=\", \" delimiter=\", \">\n          <group delimiter=\" \">\n            <text variable=\"edition\"/>\n            <text term=\"edition\"/>\n          </group>\n          <group>\n            <text term=\"section\" form=\"short\" suffix=\" \"/>\n            <text variable=\"section\"/>\n          </group>\n        </group>\n      </if>\n      <else-if type=\"article-journal\">\n        <choose>\n          <if variable=\"volume issue\" match=\"any\">\n            <text variable=\"page\" prefix=\": \"/>\n          </if>\n          <else>\n            <text variable=\"page\" prefix=\", \"/>\n          </else>\n        </choose>\n      </else-if>\n    </choose>\n  </macro>\n  <macro name=\"point-locators\">\n    <choose>\n      <if variable=\"locator\">\n        <choose>\n          <if locator=\"page\" match=\"none\">\n            <choose>\n              <if type=\"bill book graphic legal_case legislation motion_picture report song\" match=\"any\">\n                <choose>\n                  <if variable=\"volume\">\n                    <group>\n                      <text term=\"volume\" form=\"short\" suffix=\" \"/>\n                      <number variable=\"volume\" form=\"numeric\"/>\n                      <label variable=\"locator\" form=\"short\" prefix=\", \" suffix=\" \"/>\n                    </group>\n                  </if>\n                  <else>\n                    <label variable=\"locator\" form=\"short\" suffix=\" \"/>\n                  </else>\n                </choose>\n              </if>\n              <else>\n                <label variable=\"locator\" form=\"short\" suffix=\" \"/>\n              </else>\n            </choose>\n          </if>\n          <else-if type=\"bill book graphic legal_case legislation motion_picture report song\" match=\"any\">\n            <number variable=\"volume\" form=\"numeric\" suffix=\":\"/>\n          </else-if>\n        </choose>\n        <text variable=\"locator\"/>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"container-prefix\">\n    <text term=\"in\" text-case=\"capitalize-first\"/>\n  </macro>\n  <macro name=\"container-title\">\n    <choose>\n      <if type=\"chapter entry-dictionary entry-encyclopedia paper-conference\" match=\"any\">\n        <text macro=\"container-prefix\" suffix=\" \"/>\n      </if>\n    </choose>\n    <choose>\n      <if type=\"webpage\">\n        <text variable=\"container-title\" text-case=\"title\"/>\n      </if>\n      <else-if type=\"legal_case\" match=\"none\">\n        <group delimiter=\" \">\n          <text variable=\"container-title\" text-case=\"title\" font-style=\"italic\"/>\n          <choose>\n            <if type=\"post-weblog\">\n              <text value=\"(blog)\"/>\n            </if>\n          </choose>\n        </group>\n      </else-if>\n    </choose>\n  </macro>\n  <macro name=\"publisher\">\n    <group delimiter=\": \">\n      <text variable=\"publisher-place\"/>\n      <text variable=\"publisher\"/>\n    </group>\n  </macro>\n  <macro name=\"date\">\n    <choose>\n      <if variable=\"issued\">\n        <group delimiter=\" \">\n          <date variable=\"original-date\" form=\"text\" date-parts=\"year\" prefix=\"(\" suffix=\")\"/>\n          <date variable=\"issued\">\n            <date-part name=\"year\"/>\n          </date>\n        </group>\n      </if>\n      <else-if variable=\"status\">\n        <text variable=\"status\" text-case=\"capitalize-first\"/>\n      </else-if>\n      <else>\n        <text term=\"no date\" form=\"short\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"date-in-text\">\n    <choose>\n      <if variable=\"issued\">\n        <group delimiter=\" \">\n          <date variable=\"original-date\" form=\"text\" date-parts=\"year\" prefix=\"[\" suffix=\"]\"/>\n          <date variable=\"issued\">\n            <date-part name=\"year\"/>\n          </date>\n        </group>\n      </if>\n      <else-if variable=\"status\">\n        <text variable=\"status\"/>\n      </else-if>\n      <else>\n        <text term=\"no date\" form=\"short\"/>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"day-month\">\n    <date variable=\"issued\">\n      <date-part name=\"month\"/>\n      <date-part name=\"day\" prefix=\" \"/>\n    </date>\n  </macro>\n  <macro name=\"collection-title\">\n    <choose>\n      <if match=\"none\" type=\"article-journal\">\n        <choose>\n          <if match=\"none\" is-numeric=\"collection-number\">\n            <group delimiter=\", \">\n              <text variable=\"collection-title\" text-case=\"title\"/>\n              <text variable=\"collection-number\"/>\n            </group>\n          </if>\n          <else>\n            <group delimiter=\" \">\n              <text variable=\"collection-title\" text-case=\"title\"/>\n              <text variable=\"collection-number\"/>\n            </group>\n          </else>\n        </choose>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"collection-title-journal\">\n    <choose>\n      <if type=\"article-journal\">\n        <group delimiter=\" \">\n          <text variable=\"collection-title\"/>\n          <text variable=\"collection-number\"/>\n        </group>\n      </if>\n    </choose>\n  </macro>\n  <macro name=\"event\">\n    <group delimiter=\" \">\n      <choose>\n        <if variable=\"genre\">\n          <text term=\"presented at\"/>\n        </if>\n        <else>\n          <text term=\"presented at\" text-case=\"capitalize-first\"/>\n        </else>\n      </choose>\n      <text variable=\"event\"/>\n    </group>\n  </macro>\n  <macro name=\"description\">\n    <choose>\n      <if variable=\"interviewer\" type=\"interview\" match=\"any\">\n        <group delimiter=\". \">\n          <text macro=\"interviewer\"/>\n          <text variable=\"medium\" text-case=\"capitalize-first\"/>\n        </group>\n      </if>\n      <else-if type=\"patent\">\n        <group delimiter=\" \" prefix=\". \">\n          <text variable=\"authority\"/>\n          <text variable=\"number\"/>\n        </group>\n      </else-if>\n      <else>\n        <text variable=\"medium\" text-case=\"capitalize-first\" prefix=\". \"/>\n      </else>\n    </choose>\n    <choose>\n      <if variable=\"title\" match=\"none\"/>\n      <else-if type=\"thesis personal_communication speech\" match=\"any\"/>\n      <else>\n        <group delimiter=\" \" prefix=\". \">\n          <text variable=\"genre\" text-case=\"capitalize-first\"/>\n          <choose>\n            <if type=\"report\">\n              <text variable=\"number\"/>\n            </if>\n          </choose>\n        </group>\n      </else>\n    </choose>\n  </macro>\n  <macro name=\"issue\">\n    <choose>\n      <if type=\"legal_case\">\n        <text variable=\"authority\" prefix=\". \"/>\n      </if>\n      <else-if type=\"speech\">\n        <group prefix=\". \" delimiter=\", \">\n          <group delimiter=\" \">\n            <text variable=\"genre\" text-case=\"capitalize-first\"/>\n            <text macro=\"event\"/>\n          </group>\n          <text variable=\"event-place\"/>\n          <text macro=\"day-month\"/>\n        </group>\n      </else-if>\n      <else-if type=\"article-newspaper article-magazine personal_communication\" match=\"any\">\n        <date variable=\"issued\" form=\"text\" prefix=\", \"/>\n      </else-if>\n      <else-if type=\"patent\">\n        <group delimiter=\", \" prefix=\", \">\n          <group delimiter=\" \">\n            <!--Needs Localization-->\n            <text value=\"filed\"/>\n            <date variable=\"submitted\" form=\"text\"/>\n          </group>\n          <group delimiter=\" \">\n            <choose>\n              <if variable=\"issued submitted\" match=\"all\">\n                <text term=\"and\"/>\n              </if>\n            </choose>\n            <!--Needs Localization-->\n            <text value=\"issued\"/>\n            <date variable=\"issued\" form=\"text\"/>\n          </group>\n        </group>\n      </else-if>\n      <else-if type=\"article-journal\" match=\"any\"/>\n      <else>\n        <group prefix=\". \" delimiter=\", \">\n          <choose>\n            <if type=\"thesis\">\n              <text variable=\"genre\" text-case=\"capitalize-first\"/>\n            </if>\n          </choose>\n          <text macro=\"publisher\"/>\n        </group>\n      </else>\n    </choose>\n  </macro>\n  <citation et-al-min=\"4\" et-al-use-first=\"1\" disambiguate-add-year-suffix=\"true\" disambiguate-add-names=\"true\" disambiguate-add-givenname=\"true\" givenname-disambiguation-rule=\"primary-name\" collapse=\"year\" after-collapse-delimiter=\"; \">\n    <layout prefix=\"(\" suffix=\")\" delimiter=\"; \">\n      <group delimiter=\", \">\n        <choose>\n          <if variable=\"issued accessed\" match=\"any\">\n            <group delimiter=\" \">\n              <text macro=\"contributors-short\"/>\n              <text macro=\"date-in-text\"/>\n            </group>\n          </if>\n          <!---comma before forthcoming and n.d.-->\n          <else>\n            <group delimiter=\", \">\n              <text macro=\"contributors-short\"/>\n              <text macro=\"date-in-text\"/>\n            </group>\n          </else>\n        </choose>\n        <text macro=\"point-locators\"/>\n      </group>\n    </layout>\n  </citation>\n  <bibliography hanging-indent=\"true\" et-al-min=\"11\" et-al-use-first=\"7\" subsequent-author-substitute=\"&#8212;&#8212;&#8212;\" entry-spacing=\"0\">\n    <sort>\n      <key macro=\"contributors\"/>\n      <key variable=\"issued\"/>\n      <key variable=\"title\"/>\n    </sort>\n    <layout suffix=\".\">\n      <group delimiter=\". \">\n        <text macro=\"contributors\"/>\n        <text macro=\"date\"/>\n        <text macro=\"title\"/>\n      </group>\n      <text macro=\"description\"/>\n      <text macro=\"secondary-contributors\" prefix=\". \"/>\n      <text macro=\"container-title\" prefix=\". \"/>\n      <text macro=\"container-contributors\"/>\n      <text macro=\"edition\"/>\n      <text macro=\"locators-chapter\"/>\n      <text macro=\"collection-title-journal\" prefix=\", \" suffix=\", \"/>\n      <text macro=\"locators\"/>\n      <text macro=\"collection-title\" prefix=\". \"/>\n      <text macro=\"issue\"/>\n      <text macro=\"locators-article\"/>\n      <text macro=\"access\" prefix=\". \"/>\n    </layout>\n  </bibliography>\n</style>`\n","/**\n * @typedef {import('hast').Node} Node\n * @typedef {import('hast').Parent} Parent\n * @typedef {import('hast').Root} Root\n * @typedef {import('unist-util-visit').Visitor<Node>} Visitor\n * @typedef {import('./parse-citation').CiteItem} CiteItem\n * @typedef Options\n *   Configuration.\n * @property {string} [bibliography]\n *   Name of bibtex or CSL-JSON file\n * @property {string} [path]\n *   Required, path to file. Will be joined with `options.bibliography` and `options.csl`, if provided.\n * @property {'apa'|'vancouver'|'harvard1'|'chicago'|'mla'|string} [csl]\n *   One of 'apa', 'vancouver', 'harvard1', 'chicago', 'mla' or name of the local csl file\n * @property {string} [lang]\n *   Locale to use in formatting citations. Defaults to en.\n * @property {boolean} [suppressBibliography]\n *   By default, biliography is inserted after the entire markdown file.\n *   If the file contains `[^Ref]`, the biliography will be inserted there instead.\n * @property {string[]} [noCite]\n *   Citation IDs (@item1) to include in the bibliography even if they are not cited in the document\n */\n\nimport { visit } from 'unist-util-visit'\nimport fs from 'fs'\nimport path from 'path'\nimport Cite from 'citation-js'\nimport parse5 from 'parse5'\nimport { fromParse5 } from 'hast-util-from-parse5'\nimport { parseCitation } from './parse-citation.js'\nimport { citeExtractorRe } from './regex.js'\nimport mla from './csl/mla.js'\nimport chicago from './csl/chicago.js'\n\nconst defaultPath = process.cwd()\n\n// Citation.js comes with apa, harvard1 and vancouver\nconst config = Cite.plugins.config.get('@csl')\nconfig.templates.add('mla', mla)\nconfig.templates.add('chicago', chicago)\n\nconst defaultCsl = ['apa', 'vancouver', 'harvard1', 'chicago', 'mla']\nlet citeFormat = 'apa'\nconst permittedTags = ['div', 'p', 'span', 'li']\n\nconst customCslConfig = (path, csl) => {\n  if (defaultCsl.includes(csl)) {\n    citeFormat = csl\n  } else if (fs.existsSync(path)) {\n    config.templates.add(csl, fs.readFileSync(path, 'utf8'))\n  } else {\n    throw new Error('Invalid csl name or path')\n  }\n}\n\n/**\n * Generate citation using citeproc\n * This accounts for prev citations and additional properties\n *\n * @param {*} citeproc\n * @param {CiteItem[]} entries\n * @param {string} citationId\n * @param {any[]} citationPre\n * @param {*} [properties={ noteIndex: 0 }]\n * @return {*}\n */\nconst genCitation = (citeproc, entries, citationId, citationPre, properties = { noteIndex: 0 }) => {\n  const c = citeproc.processCitationCluster(\n    {\n      citationID: citationId,\n      citationItems: entries,\n      properties: properties,\n    },\n    citationPre.length > 0 ? citationPre : [],\n    []\n  )\n  // c = [ { bibchange: true, citation_errors: [] }, [ [ 0, '(1)', 'CITATION-1' ] ]]\n  const result = c[1].filter((x) => x[2] === citationId)\n  // Coerce to html to parse HTML code e.g. &#38; and return text node\n  const p5ast = parse5.parseFragment(`<div>${result[0][1]}</div>`)\n  const citeNode = fromParse5(p5ast).children[0]\n  const textNode = citeNode.children[0]\n  return textNode\n}\n\n/**\n * Generate bibliography in html and convert it to hast\n *\n * @param {*} citeproc\n */\nconst genBiblioNode = (citeproc) => {\n  const [, bibBody] = citeproc.makeBibliography()\n  const bibliography =\n    '<div id=\"refs\" class=\"references csl-bib-body\">\\n' + bibBody.join('') + '</div>'\n  const p5ast = parse5.parseFragment(bibliography)\n  const biblioNode = fromParse5(p5ast).children[0]\n  return biblioNode\n}\n\n/**\n * Rehype plugin that formats citations in markdown documents and insert bibliography in html format\n *\n *    [-@wadler1990]                              --> (1990)\n *    [@hughes1989, sec 3.4]                      --> (Hughes 1989, sec 3.4)\n *    [see @wadler1990; and @hughes1989, pp. 4]   --> (see Wadler 1990 and Hughes 1989, pp. 4)\n * @type {import('unified').Plugin<[Options?], Root>}\n */\nconst rehypeCitation = (options = {}) => {\n  return (tree) => {\n    if (!options.bibliography) return\n\n    const bibtexFile = fs.readFileSync(\n      path.join(options.path || defaultPath, options.bibliography),\n      'utf8'\n    )\n    citeFormat = 'apa'\n\n    if (options.csl) {\n      customCslConfig(path.join(options.path || defaultPath, options.csl), options.csl)\n    }\n\n    const citations = new Cite(bibtexFile)\n    const citationIds = citations.data.map((x) => x.id)\n    const citationPre = []\n    let citationId = 1\n    const citeproc = config.engine(citations.data, citeFormat, options.lang || 'en', 'html')\n\n    visit(tree, 'text', (node, idx, parent) => {\n      const match = node.value.match(citeExtractorRe)\n      //@ts-ignore\n      if (!match || !permittedTags.includes(parent.tagName)) return\n      const citeStartIdx = match.index\n      const citeEndIdx = match.index + match[0].length\n      const newChildren = []\n      // if preceding string\n      if (citeStartIdx !== 0) {\n        // create a new child node\n        newChildren.push({\n          type: 'text',\n          value: node.value.slice(0, citeStartIdx),\n        })\n      }\n\n      const [properties, entries] = parseCitation(match[0])\n\n      // If id is not in citation file (e.g. route alias or js package), abort process\n      for (const citeItem of entries) {\n        if (!citationIds.includes(citeItem.id)) return\n      }\n\n      const citedTextNode = genCitation(\n        citeproc,\n        entries,\n        `CITATION-${citationId}`,\n        citationPre,\n        properties\n      )\n\n      // Prepare citationPre and citationId for the next cite instance\n      citationPre.push([`CITATION-${citationId}`, 0])\n      citationId = citationId + 1\n\n      // TODO: return html with link\n      newChildren.push(citedTextNode)\n\n      // if trailing string\n      if (citeEndIdx < node.value.length) {\n        newChildren.push({\n          type: 'text',\n          value: node.value.slice(citeEndIdx),\n        })\n      }\n\n      // insert into the parent\n      parent.children = [\n        ...parent.children.slice(0, idx),\n        ...newChildren,\n        ...parent.children.slice(idx + 1),\n      ]\n    })\n\n    if (options.noCite) {\n      citeproc.updateItems(options.noCite.map((x) => x.replace('@', '')))\n    }\n\n    if (!options.suppressBibliography && citeproc.registry.mylist.length >= 1) {\n      const biblioNode = genBiblioNode(citeproc)\n      let bilioInserted = false\n\n      // Insert it at ^ref, if not found insert it as the last element of the tree\n      visit(tree, 'element', (node, idx, parent) => {\n        if (\n          (node.tagName === 'p' || node.tagName === 'div') &&\n          node.children[0].value === '[^ref]'\n        ) {\n          parent.children[idx] = biblioNode\n          bilioInserted = true\n        }\n      })\n\n      if (!bilioInserted) {\n        tree.children.push(biblioNode)\n      }\n    }\n  }\n}\n\nexport default rehypeCitation\n"],"names":["citeExtractorRe","citeKeyRe","citeBracketRe","locatorMapping","book","chapter","column","figure","folio","number","line","note","opus","page","paragraph","part","section","verse","volume","parseCitation","citeString","entries","properties","test","noteIndex","citeItems","substr","length","split","citeItem","prefix","locator","label","suffix","citeChunk","Error","trim","suppressAuthor","indexOf","commaIndex","undefined","citeKey","match","afterKey","locatorMatch","push","id","matchAll","mode","map","str","defaultPath","process","cwd","config","Cite","plugins","get","templates","add","mla","chicago","defaultCsl","citeFormat","permittedTags","customCslConfig","path","csl","includes","fs","existsSync","readFileSync","genCitation","citeproc","citationId","citationPre","c","processCitationCluster","citationID","citationItems","result","filter","x","p5ast","parse5","parseFragment","citeNode","fromParse5","children","textNode","genBiblioNode","bibBody","makeBibliography","bibliography","join","biblioNode","rehypeCitation","options","tree","bibtexFile","citations","citationIds","data","engine","lang","visit","node","idx","parent","value","tagName","citeStartIdx","index","citeEndIdx","newChildren","type","slice","citedTextNode","noCite","updateItems","replace","suppressBibliography","registry","mylist","bilioInserted"],"mappings":"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X;AACAC,QAAAA,EAAE,EAAE,CAAC,GAAGjB,QAAQ,CAACkB,QAAT,CAAkB9C,SAAlB,CAAJ,EAAkC,CAAlC,EAAqC,CAArC,CAFO;AAGX8B,QAAAA,OAHW;AAIXC,QAAAA,KAJW;AAKXF,QAAAA,MALW;AAMXG,QAAAA,MANW;AAOX,2BAAmBI;AAPR,OAAb;AASD;AACF,GA7DD,MA6DO;AACL;AACA;AACAf,IAAAA,UAAU,GAAG;AAAEE,MAAAA,SAAS,EAAE,CAAb;AAAgBwB,MAAAA,IAAI,EAAE;AAAtB,KAAb;AACA3B,IAAAA,OAAO,GAAG,CAACD,UAAD,EAAa6B,GAAb,CAAkBC,GAAD,KAAU;AACnCJ,MAAAA,EAAE,EAAE,CAAC,GAAGI,GAAG,CAACH,QAAJ,CAAa9C,SAAb,CAAJ,EAA6B,CAA7B,EAAgC,CAAhC;AAD+B,KAAV,CAAjB,CAAV;AAGD;;AACD,SAAO,CAACqB,UAAD,EAAaD,OAAb,CAAP;AACD,CA1EM;;ACnFP,UAAgB;AAChB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAnUA;;ACAA,cAAgB;AAChB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAjpBA;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAaA,MAAM8B,WAAW,GAAGC,OAAO,CAACC,GAAR,EAApB;;AAGA,MAAMC,MAAM,GAAGC,IAAI,CAACC,OAAL,CAAaF,MAAb,CAAoBG,GAApB,CAAwB,MAAxB,CAAf;AACAH,MAAM,CAACI,SAAP,CAAiBC,GAAjB,CAAqB,KAArB,EAA4BC,GAA5B;AACAN,MAAM,CAACI,SAAP,CAAiBC,GAAjB,CAAqB,SAArB,EAAgCE,OAAhC;AAEA,MAAMC,UAAU,GAAG,CAAC,KAAD,EAAQ,WAAR,EAAqB,UAArB,EAAiC,SAAjC,EAA4C,KAA5C,CAAnB;AACA,IAAIC,UAAU,GAAG,KAAjB;AACA,MAAMC,aAAa,GAAG,CAAC,KAAD,EAAQ,GAAR,EAAa,MAAb,EAA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"}